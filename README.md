# Telegram Analytics Bot (Test Assignment)

Telegram-–±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –≤–∏–¥–µ–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ (RU).  
–ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é LLM –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL.

–ü–æ–¥–æ–ø—ã—Ç–Ω–∞—è LLM: `Qwen/Qwen3-4B-Instruct-2507` (–≤—ã–≥—Ä—É–∑–∫–∞ –Ω–∞ RTX3070)

---

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

```bash
git clone https://github.com/Vludd/video-analyser-tg-bot.git
cd video-analyser-tg-bot
```

### –ó–∞–ø—É—Å–∫ —Å Docker

#### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å `.env` —Ñ–∞–π–ª

```bash
cp .env.example .env
```

–§–∞–π–ª `.env.example` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å.

#### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å

```bash
docker-compose up --build
```

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

* –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
* –ª–æ–∫–∞–ª—å–Ω–∞—è LLM —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—Å—è –≤ VRAM
* –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è PostgreSQL
* —Å–æ–∑–¥–∞–¥—É—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã
* –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
* Telegram –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∏ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

---

### üíª –ó–∞–ø—É—Å–∫ –±–µ–∑ Docker

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
python -m venv venv
source venv/bin/activate           # Linux / Mac
venv\Scripts\activate              # Windows
pip install -r requirements.txt
```

#### 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å `.env` —Ñ–∞–π–ª

```bash
cp .env.example .env
```

–§–∞–π–ª `.env.example` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å.

#### 3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–º–∏

```bash
python -m app.database.init_data
```

–§–∞–π–ª —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (`videos.json`) –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å –≤ `app/data`, —Ä—è–¥–æ–º —Å `prompt.md`.

#### 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å

```bash
python -m app.main
```

---

## üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –æ–±—â–∏–π –ø–æ–¥—Ö–æ–¥

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
> –°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É (RU) > LLM (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
> Backend: JSON –≤ –º–æ–¥–µ–ª—å —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö + –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ \
> –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏–∑ PostgreSQL \
> –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º (int)
```

---

## üìä –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–ø—Ä–æ—Å –∫ –ë–î

### –ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø

* **–ë–µ–∑ –¥–∞—Ç—ã** - —Å—á–∏—Ç–∞–µ–º *—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è* (`videos`)
* **–° –¥–∞—Ç–æ–π / –ø–µ—Ä–∏–æ–¥–æ–º** - —Å—á–∏—Ç–∞–µ–º *–∏–∑–º–µ–Ω–µ–Ω–∏—è* (`video_snapshots.delta_*`)

–ü—Ä–∏–º–µ—Ä—ã:

* "–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≤–∏–¥–µ–æ?" - `COUNT(videos)`
* "–°–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ 28 –Ω–æ—è–±—Ä—è?" - `SUM(video_snapshots.delta_views_count)`
* "–°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –Ω–∞–±—Ä–∞–ª–æ –±–æ–ª—å—à–µ 100 000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?" - `videos.views_count > 100000`

---

## üß© –†–æ–ª—å LLM

LLM **–Ω–µ –ø–∏—à–µ—Ç SQL** –∏ **–Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î**.

–û–Ω–∞:

1. –ü–æ–Ω–∏–º–∞–µ—Ç —Å—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞
2. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç **—Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON** –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–º—É –ø—Ä–æ–º–ø—Ç—É

---

## üìú –§–æ—Ä–º–∞—Ç JSON –æ—Ç LLM

```json
{
  "query_type": "sum_delta_views",
  "filters": {
    "creator_id": null,
    "date_from": "2025-11-28",
    "date_to": "2025-11-28",
    "min_views": null
  }
}
```

---

## üß† –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM

```json
–¢—ã ‚Äî —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–≤ –°–¢–†–û–ì–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.

–ü—Ä–∞–≤–∏–ª–∞:
- –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON
- –ë–µ–∑ —Ç–µ–∫—Å—Ç–∞, –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ markdown
- –í—Å–µ –¥–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
- –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å—Ç–∞–≤—å null
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ query_type

–î–æ–ø—É—Å—Ç–∏–º—ã–µ query_type:
- count_videos
- sum_views
- count_videos_with_views_gt
- sum_delta_views
- count_distinct_videos_with_delta

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
{
  "query_type": "...",
  "filters": {
    "creator_id": null,
    "date_from": null,
    "date_to": null,
    "min_views": null
  }
}
```

---

## Backend-–ª–æ–≥–∏–∫–∞

1. –û—Ç–≤–µ—Ç LLM –ø–∞—Ä—Å–∏—Ç—Å—è (`json.loads`)
2. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Pydantic
3. –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ dispatcher
4. Dispatcher –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å SQLAlchemy
5. –†–µ–∑—É–ª—å—Ç–∞—Ç (`int`) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## –ü–æ—á–µ–º—É —Ç–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥

* –ù–µ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π SQL
* –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
* –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è —Ä–∞–∑–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏
* –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤)
* –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
